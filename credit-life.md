# Credit-Life Quote Generation - Complete Flow Chart & Details

## REQUEST FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLIENT REQUEST: POST /api/minterprise/v1/products/credit-life/quotes                    â”‚
â”‚ Headers: x-partner-id, x-user-id, x-tenant, x-broker                                   â”‚
â”‚ Body: PayloadWrapper { data: PremiumRequest }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 1: PremiumQuoteController.getResult()                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ â€¢ Extract headers: partnerId, userId, tenant, broker                                    â”‚
â”‚ â€¢ Deserialize request.getData() â†’ PremiumRequest                                        â”‚
â”‚ â€¢ Set productCode, tenant, broker, partnerId, userId                                    â”‚
â”‚ â€¢ Log: "[Premium Controller] Received Request to calculate premium"                     â”‚
â”‚ â€¢ Call: premiumQuoteService.getResult(premiumRequest)                                   â”‚
â”‚ â€¢ Return: ResponseEntity with PayloadWrapper                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 2: PremiumQuoteService.getResult()                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ â”Œâ”€ Validate Quote Request using ValidationUtil                                         â”‚
â”‚ â”‚  â””â”€ If validation fails: Return error response                                        â”‚
â”‚ â”‚                                                                                       â”‚
â”‚ â””â”€ Call validatePremium(request) â†’ Mono<PremiumValidationResponse>                     â”‚
â”‚                                                                                        â”‚
â”‚ â”Œâ”€ validatePremium() LOGIC:                                                            â”‚
â”‚ â”‚                                                                                       â”‚
â”‚ â”‚  Check if new request:                                                               â”‚
â”‚ â”‚    â€¢ Both referenceId and quoteId blank? â†’ isInitial = true                          â”‚
â”‚ â”‚      â””â”€ Generate new referenceId via UniqueIdGenerator                               â”‚
â”‚ â”‚                                                                                       â”‚
â”‚ â”‚  Check flowType:                                                                     â”‚
â”‚ â”‚    â€¢ SINGLE_RESULT? â†’ Validate planCode and insurerCode exist                        â”‚
â”‚ â”‚    â€¢ Otherwise? â†’ Generate quoteId using UUID                                        â”‚
â”‚ â”‚                                                                                       â”‚
â”‚ â”‚  Set timestamps:                                                                     â”‚
â”‚ â”‚    â€¢ createdAt = new Date()                                                          â”‚
â”‚ â”‚    â€¢ updatedAt = new Date()                                                          â”‚
â”‚ â”‚                                                                                       â”‚
â”‚ â”‚  Call performValidation(request, isInitial):                                         â”‚
â”‚ â”‚    â”œâ”€ If isInitial=true: Save to DB immediately                                      â”‚
â”‚ â”‚    â””â”€ If isInitial=false: Fetch from DB and validate                                 â”‚
â”‚ â”‚                                                                                       â”‚
â”‚ â”‚  Call processValidationResponse():                                                   â”‚
â”‚ â”‚    â”œâ”€ Product-specific validator (CreditLifeProductCodeValidator)                    â”‚
â”‚ â”‚    â”œâ”€ Encrypt premium request                                                        â”‚
â”‚ â”‚    â”œâ”€ Apply retain logic                                                             â”‚
â”‚ â”‚    â”œâ”€ Save to Database                                                               â”‚
â”‚ â”‚    â””â”€ Return: PremiumValidationResponse { valid, premiumRequest }                    â”‚
â”‚ â”‚                                                                                       â”‚
â”‚ â””â”€ Return: Flux of validated responses                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE SAVE #1: CreditLifePremiumRequestRepository.save()                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ Collection: credit_life_premium_request                                                 â”‚
â”‚ Saves:                                                                                  â”‚
â”‚   â€¢ referenceId (unique)                                                                â”‚
â”‚   â€¢ quoteId (unique)                                                                    â”‚
â”‚   â€¢ customerId                                                                          â”‚
â”‚   â€¢ riskInsured details                                                                 â”‚
â”‚   â€¢ addOns requested                                                                    â”‚
â”‚   â€¢ createdAt, updatedAt timestamps                                                     â”‚
â”‚   â€¢ productCode, brokerCode, tenantCode                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATABASE SAVE #1B: PremiumRequestHistoryRepository.save()                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ Collection: premium_request_history                                                     â”‚
â”‚ Purpose: Audit trail for all premium request changes                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 3: Get Product-Specific Aggregator                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ PremiumAggregatorFactory.getPremiumAggregator("credit-life")                            â”‚
â”‚   â””â”€ Returns: CreditLifeAggregator instance                                             â”‚
â”‚       (implements IPremiumAggregator)                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 4: CreditLifeAggregator.getPremium()                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 1: Prepare Borrower Details                                               â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚ For each borrower in riskInsured.borrowerDetails:                               â”‚   â”‚
â”‚ â”‚   â€¢ Parse dateOfBirth (String â†’ LocalDate â†’ LocalDateTime â†’ Timestamp)          â”‚   â”‚
â”‚ â”‚   â€¢ Set borrower properties                                                      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 2: Fetch Data IN PARALLEL (Using Reactor's zipWith)                       â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Mono 1: getLoanTypeMapping()                                                    â”‚   â”‚
â”‚ â”‚  â”œâ”€ Query: LoanTypeMastersRepository                                            â”‚   â”‚
â”‚ â”‚  â”œâ”€ Filter by: bankLoanType, broker, provider                                   â”‚   â”‚
â”‚ â”‚  â””â”€ Return: LoanMasters { code, name, mapping }                                 â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Mono 2: getCustomerDetails()                                                    â”‚   â”‚
â”‚ â”‚  â”œâ”€ Call: CommonVerticalService.getCustomerDetails(customerId, broker, tenant)  â”‚   â”‚
â”‚ â”‚  â”‚         ğŸ”¹ EXTERNAL SERVICE CALL #1                                          â”‚   â”‚
â”‚ â”‚  â””â”€ Return: CustomerDetails { name, age, income, occupation, kyc }              â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Mono 3: Get Live Product Plans                                                  â”‚   â”‚
â”‚ â”‚  â”œâ”€ Call: ProductCatalogV2Service.getLiveProductListFromHub()                   â”‚   â”‚
â”‚ â”‚  â”‚         (broker, "CREDIT_LIFE", "LIFE")                                      â”‚   â”‚
â”‚ â”‚  â”‚         ğŸ”¹ EXTERNAL SERVICE CALL #2                                          â”‚   â”‚
â”‚ â”‚  â””â”€ Return: List<ProductWithVariants> [                                         â”‚   â”‚
â”‚ â”‚            {                                                                     â”‚   â”‚
â”‚ â”‚              productCode: "tataaiali-credit-life-supreme",                       â”‚   â”‚
â”‚ â”‚              hubProductCode: "TATA-CL-SUP",                                      â”‚   â”‚
â”‚ â”‚              insurerCode: "TATAAIALI",                                           â”‚   â”‚
â”‚ â”‚              planName: "Supreme Plan",                                           â”‚   â”‚
â”‚ â”‚              ...                                                                 â”‚   â”‚
â”‚ â”‚            },                                                                    â”‚   â”‚
â”‚ â”‚            { ... more plans ... }                                               â”‚   â”‚
â”‚ â”‚          ]                                                                       â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 3: Create Validation Map                                                  â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Input: List<ProductWithVariants> from previous step                             â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Step 1: Extract all hubProductCodes from plans                                  â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Step 2: Build Validation Scope:                                                 â”‚   â”‚
â”‚ â”‚  â”œâ”€ age (of primary borrower)                                                   â”‚   â”‚
â”‚ â”‚  â”œâ”€ policyTerm                                                                  â”‚   â”‚
â”‚ â”‚  â”œâ”€ premiumPaymentTerm                                                          â”‚   â”‚
â”‚ â”‚  â”œâ”€ premiumPaymentMode                                                          â”‚   â”‚
â”‚ â”‚  â”œâ”€ sumAssuredOnDeath                                                           â”‚   â”‚
â”‚ â”‚  â””â”€ loanType                                                                    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Step 3: Call ProductCatalogV2Service.validateAndGenerateValidationMap()         â”‚   â”‚
â”‚ â”‚         ğŸ”¹ EXTERNAL SERVICE CALL #3                                             â”‚   â”‚
â”‚ â”‚         (productCodes, validationScope)                                          â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Step 4: Filter results where score == 0.0 (exact match)                         â”‚   â”‚
â”‚ â”‚         â””â”€ Return: ArrayList<ProductWithVariants> (only eligible plans)          â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 4: Generate Premium Service Requests                                       â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ For each eligible plan in ArrayList<ProductWithVariants>:                        â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚   CREATE: CreditLifePremiumServiceRequest                                        â”‚   â”‚
â”‚ â”‚   â””â”€ Copy: customerDetails, borrowerDetails, loanData                           â”‚   â”‚
â”‚ â”‚   â””â”€ Set: planCode, insurerCode, hubProductCode                                 â”‚   â”‚
â”‚ â”‚   â””â”€ Set: underwritingData, riskDetails                                         â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Result: List<CreditLifePremiumServiceRequest> (one per eligible plan)           â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 5: For EACH Plan â†’ Create Draft Premium Result & Get Constants             â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ flatMapMany(List â†’ Flux) - Process each plan in sequence                        â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ STEP A: flatMap(pr â†’                                                            â”‚   â”‚
â”‚ â”‚         populateConstantsInPremiumRequest(premiumRequest, pr))                   â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚         â”œâ”€ Call: getIhConstants(insurerCode, broker, "PREMIUM")                  â”‚   â”‚
â”‚ â”‚         â”‚         ğŸ”¹ DATABASE QUERY #1                                           â”‚   â”‚
â”‚ â”‚         â”‚         Query: IntegrationsHubConstants                                â”‚   â”‚
â”‚ â”‚         â”‚         By: insurerCode, stage, broker, provider                       â”‚   â”‚
â”‚ â”‚         â”‚                                                                        â”‚   â”‚
â”‚ â”‚         â”œâ”€ Return: IntegrationsHubConstants {                                    â”‚   â”‚
â”‚ â”‚         â”‚            constants: {                                                â”‚   â”‚
â”‚ â”‚         â”‚              serviceUrl: "...",                                        â”‚   â”‚
â”‚ â”‚         â”‚              credentialKey: "...",                                     â”‚   â”‚
â”‚ â”‚         â”‚              ...configuration...                                       â”‚   â”‚
â”‚ â”‚         â”‚            }                                                           â”‚   â”‚
â”‚ â”‚         â”‚          }                                                             â”‚   â”‚
â”‚ â”‚         â”‚                                                                        â”‚   â”‚
â”‚ â”‚         â””â”€ Set pr.constants = ihConstants.getConstants()                        â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ STEP B: flatMap(constants â†’                                                     â”‚   â”‚
â”‚ â”‚         createAndSaveInitialDraftPremiumResult(premiumRequest, pr))              â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚         â”œâ”€ Create: PremiumResult {                                               â”‚   â”‚
â”‚ â”‚         â”‚            status: "DRAFT",                                            â”‚   â”‚
â”‚ â”‚         â”‚            referenceId, quoteId, planCode, insurerCode,                â”‚   â”‚
â”‚ â”‚         â”‚            customerId, broker, tenant,                                 â”‚   â”‚
â”‚ â”‚         â”‚            ...                                                         â”‚   â”‚
â”‚ â”‚         â”‚          }                                                             â”‚   â”‚
â”‚ â”‚         â”‚                                                                        â”‚   â”‚
â”‚ â”‚         â”œâ”€ Validate & Set Addons:                                                â”‚   â”‚
â”‚ â”‚         â”‚  â”œâ”€ Call: ProductCatalogV2Service.getAggregatedProductInfo()            â”‚   â”‚
â”‚ â”‚         â”‚  â”‚         ğŸ”¹ EXTERNAL SERVICE CALL #4                                â”‚   â”‚
â”‚ â”‚         â”‚  â”‚         (ProductCatalogV2Request)                                   â”‚   â”‚
â”‚ â”‚         â”‚  â”‚                                                                     â”‚   â”‚
â”‚ â”‚         â”‚  â”œâ”€ Get: Applicable addons list                                        â”‚   â”‚
â”‚ â”‚         â”‚  â”‚                                                                     â”‚   â”‚
â”‚ â”‚         â”‚  â”œâ”€ Call: getAddOnDataByCodeRemote(addonCodes, insurerCode)            â”‚   â”‚
â”‚ â”‚         â”‚  â”‚         ğŸ”¹ EXTERNAL SERVICE CALL #5                                â”‚   â”‚
â”‚ â”‚         â”‚  â”‚                                                                     â”‚   â”‚
â”‚ â”‚         â”‚  â”œâ”€ Merge: Requested addons with applicable addons                    â”‚   â”‚
â”‚ â”‚         â”‚  â”‚  â””â”€ Set selected status, premium amounts                           â”‚   â”‚
â”‚ â”‚         â”‚  â”‚                                                                     â”‚   â”‚
â”‚ â”‚         â”‚  â””â”€ Set addonStatus = "in_progress" (if any selected)                 â”‚   â”‚
â”‚ â”‚         â”‚                       or "success" (if none selected)                  â”‚   â”‚
â”‚ â”‚         â”‚                                                                        â”‚   â”‚
â”‚ â”‚         â”œâ”€ Save to Database (if not SINGLE_RESULT flow):                         â”‚   â”‚
â”‚ â”‚         â”‚  â””â”€ ğŸ”¹ DATABASE SAVE #2:                                             â”‚   â”‚
â”‚ â”‚         â”‚     CreditLifePremiumResultRepository.save(premiumResult)              â”‚   â”‚
â”‚ â”‚         â”‚     Collection: credit_life_premium_result                             â”‚   â”‚
â”‚ â”‚         â”‚                                                                        â”‚   â”‚
â”‚ â”‚         â””â”€ Return: Tuple2<PremiumResult, CreditLifePremiumServiceRequest>        â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 6: Send Premium Request to Insurance Hub (IF NOT SINGLE_RESULT)             â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ CONDITION: if (flowType != SINGLE_RESULT)                                        â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ Call: sendPremiumRequestToInsurer(premiumResultTuple)                            â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ THIS IS ASYNC (doOnNext) - Happens in background                                â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚ â”‚ â”‚ Inside sendPremiumRequestToInsurer():                                      â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                                                                            â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ 1. Extract: PremiumResult and CreditLifePremiumServiceRequest              â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                                                                            â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ 2. Set branch code: pr.getCustomerDetails().setBranchCode("550213")       â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                                                                            â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ 3. Call: ihService.sendPremiumRequestToIH(                                 â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          insurerCode = "TATAAIALI",                                        â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          productCode = "CREDIT_LIFE",                                      â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          planCode = hubProductCode,                                        â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          broker = "centralbank",                                           â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          tenant = "centralbank",                                           â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          referenceId = unique-id,                                          â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          premiumRequest = CreditLifePremiumServiceRequest,                 â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          null,                                                             â”‚ â”‚   â”‚
â”‚ â”‚ â”‚          planCode                                                          â”‚ â”‚   â”‚
â”‚ â”‚ â”‚        )                                                                   â”‚ â”‚   â”‚
â”‚ â”‚ â”‚        ğŸ”¹ EXTERNAL SERVICE CALL #6 - INSURANCE HUB                        â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                                                                            â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ 4. In IHService.sendPremiumRequestToIH():                                  â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â”œâ”€ Build IHRequest from CreditLifePremiumServiceRequest                 â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â”œâ”€ Set: IHRequest.uniqueId = referenceId                               â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â””â”€ Call: sendRequestToIH()                                              â”‚ â”‚   â”‚
â”‚ â”‚ â”‚           â””â”€ Send to Insurance Hub endpoint                               â”‚ â”‚   â”‚
â”‚ â”‚ â”‚           â””â”€ Endpoint: Dynamically constructed                             â”‚ â”‚   â”‚
â”‚ â”‚ â”‚           â””â”€ Method: POST                                                  â”‚ â”‚   â”‚
â”‚ â”‚ â”‚           â””â”€ Returns: IHResponse {                                         â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                 success: true,                                             â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                 data: {                                                     â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                   netPremium: 1500.00,                                      â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                   grossPremium: 1770.00,                                    â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                   gst: 270.00,                                              â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                   commission: 0.00,                                         â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                   otherCharges: 0.00,                                       â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                   policyDetails: {...},                                    â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                   ...                                                      â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                 }                                                           â”‚ â”‚   â”‚
â”‚ â”‚ â”‚               }                                                             â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                                                                            â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ 5. Map response to CreditLifePremiumResult:                                â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â”œâ”€ Convert resp.getData() to CreditLifePremiumResult                    â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â””â”€ Handle ObjectMapper exceptions                                       â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                                                                            â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ 6. Update Premium Result: updatePremiumResult()                            â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â”œâ”€ Merge IH response with existing premium result                       â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â”œâ”€ Set status = "SUCCESS" (if IH success)                               â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â”œâ”€ Set status = "FAILURE" (if IH failure)                               â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â”‚                                                                        â”‚ â”‚   â”‚
â”‚ â”‚ â”‚    â””â”€ ASYNC Save to Database:                                              â”‚ â”‚   â”‚
â”‚ â”‚ â”‚       ğŸ”¹ DATABASE SAVE #3:                                               â”‚ â”‚   â”‚
â”‚ â”‚ â”‚       CreditLifePremiumResultRepository.save(updatedResult)                â”‚ â”‚   â”‚
â”‚ â”‚ â”‚                                                                            â”‚ â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚                                                                                  â”‚   â”‚
â”‚ â””â”€ Return: Original tuple (continue processing)                                  â”‚   â”‚
â”‚                                                                                  â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CONTINUATION: Phase 7 & 8

```
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 7: Calculate Premium with Addons (IF SINGLE_RESULT FLOW)                   â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ flatMap(tuple â†’ {                                                               â”‚   â”‚
â”‚ â”‚   if (!SINGLE_RESULT.equals(flowType)) {                                        â”‚   â”‚
â”‚ â”‚     return Mono.just(tuple)                                                     â”‚   â”‚
â”‚ â”‚            .doOnNext(sendPremiumRequestToInsurer)  â† Already done               â”‚   â”‚
â”‚ â”‚            .thenReturn(tuple.getT1());  â† Return PremiumResult                  â”‚   â”‚
â”‚ â”‚   } else {                                                                       â”‚   â”‚
â”‚ â”‚     return calculatePremiumWithAddon(tuple.getT2(), premiumRequest)             â”‚   â”‚
â”‚ â”‚            â”œâ”€ Extract premium request from tuple                                â”‚   â”‚
â”‚ â”‚            â”œâ”€ Call IH with addon calculation flag                               â”‚   â”‚
â”‚ â”‚            â”œâ”€ Get addon premium amounts                                         â”‚   â”‚
â”‚ â”‚            â””â”€ Return: Updated PremiumResult with addon costs                    â”‚   â”‚
â”‚ â”‚   }                                                                              â”‚   â”‚
â”‚ â”‚ })                                                                               â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â†“                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ PHASE 8: Aggregate & Build Response                                              â”‚   â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ collectList() - Collect all PremiumResult objects from Flux                      â”‚   â”‚
â”‚ â”‚      â†“                                                                           â”‚   â”‚
â”‚ â”‚ .map(results â†’ buildPremiumResponse(results, premiumRequest))                    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ buildPremiumResponse():                                                          â”‚   â”‚
â”‚ â”‚   â”œâ”€ Create: PremiumResponse {                                                  â”‚   â”‚
â”‚ â”‚   â”‚            quotes: [ PremiumResult from each plan ],                         â”‚   â”‚
â”‚ â”‚   â”‚            premiumRequest: original request,                                â”‚   â”‚
â”‚ â”‚   â”‚            referenceId, quoteId                                             â”‚   â”‚
â”‚ â”‚   â”‚          }                                                                  â”‚   â”‚
â”‚ â”‚   â”‚                                                                             â”‚   â”‚
â”‚ â”‚   â””â”€ Return: PremiumResponse                                                    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ .doOnNext(resp â†’ saveQuotationLead(resp, creditLifePremiumServiceRequestList))   â”‚   â”‚
â”‚ â”‚     ğŸ”¹ ASYNC: Save lead data for analytics/CRM                                 â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â”‚ .flux() - Convert Mono to Flux for streaming                                    â”‚   â”‚
â”‚ â”‚                                                                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACK TO CONTROLLER: Map and Transform Response                                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ .map(premiumResponse â†’ {                                                               â”‚
â”‚   if (premiumResponse instanceof PremiumResponse)                                       â”‚
â”‚     return ResponseEntity.of(                                                          â”‚
â”‚       Optional.of(PayloadWrapper.generateResponse(premiumResponse, null))              â”‚
â”‚     )                                                                                   â”‚
â”‚   else if (premiumResponse instanceof ErrorResponseData)                                â”‚
â”‚     return new ResponseEntity<>(                                                       â”‚
â”‚       PayloadWrapper.generateResponse(premiumResponse, new MetaInfo("FAILURE", true)), â”‚
â”‚       HttpStatus.BAD_REQUEST                                                           â”‚
â”‚     )                                                                                   â”‚
â”‚   else                                                                                  â”‚
â”‚     return ResponseEntity.status(HttpStatus.OK).build()                                â”‚
â”‚ })                                                                                      â”‚
â”‚                                                                                         â”‚
â”‚ .elementAt(0)  â† Extract first element from Flux                                       â”‚
â”‚   â””â”€ Returns: Mono<ResponseEntity>                                                     â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FINAL RESPONSE: HTTP 200 OK                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                                         â”‚
â”‚ {                                                                                       â”‚
â”‚   "responseStatus": "SUCCESS",                                                          â”‚
â”‚   "data": {                                                                             â”‚
â”‚     "referenceId": "9e8b7c6d-5a4f-3e2d-1c0b-9a8f7e6d5c4b",                             â”‚
â”‚     "quoteId": "QUOTE-UUID-123",                                                        â”‚
â”‚     "premiumRequest": { ... original request ... },                                     â”‚
â”‚     "quotes": [                                                                         â”‚
â”‚       {                                                                                 â”‚
â”‚         "quoteId": "QUOTE-UUID-123",                                                    â”‚
â”‚         "referenceId": "9e8b7c6d-5a4f-3e2d-1c0b-9a8f7e6d5c4b",                         â”‚
â”‚         "insurerCode": "TATAAIALI",                                                     â”‚
â”‚         "planCode": "tataaiali-credit-life-supreme",                                    â”‚
â”‚         "hubProductCode": "TATA-CL-SUP",                                                â”‚
â”‚         "productCode": "credit-life",                                                   â”‚
â”‚         "netPremium": 1500.00,                                                          â”‚
â”‚         "grossPremium": 1770.00,                                                        â”‚
â”‚         "gst": 270.00,                                                                  â”‚
â”‚         "commission": 0.00,                                                             â”‚
â”‚         "otherCharges": 0.00,                                                           â”‚
â”‚         "totalPremium": 1770.00,                                                        â”‚
â”‚         "status": "SUCCESS",                                                            â”‚
â”‚         "policyTerm": 10,                                                               â”‚
â”‚         "premiumPaymentTerm": 12,                                                       â”‚
â”‚         "premiumPaymentMode": "Yearly",                                                 â”‚
â”‚         "sumInsured": 3000000.00,                                                       â”‚
â”‚         "addOns": [                                                                     â”‚
â”‚           {                                                                             â”‚
â”‚             "addOnCode": "CI",                                                          â”‚
â”‚             "addOnName": "Critical Illness",                                            â”‚
â”‚             "selected": false,                                                          â”‚
â”‚             "premium": 100.00                                                           â”‚
â”‚           },                                                                            â”‚
â”‚           {                                                                             â”‚
â”‚             "addOnCode": "ACC",                                                         â”‚
â”‚             "addOnName": "Accidental Death Benefit",                                    â”‚
â”‚             "selected": true,                                                           â”‚
â”‚             "premium": 50.00                                                            â”‚
â”‚           }                                                                             â”‚
â”‚         ],                                                                              â”‚
â”‚         "addOnStatus": "in_progress",                                                   â”‚
â”‚         "createdAt": "2026-01-30T10:30:00.000Z",                                        â”‚
â”‚         "updatedAt": "2026-01-30T10:30:15.000Z"                                         â”‚
â”‚       },                                                                                â”‚
â”‚       { ... more quotes from other insurers ... }                                       â”‚
â”‚     ]                                                                                   â”‚
â”‚   },                                                                                    â”‚
â”‚   "meta": {                                                                             â”‚
â”‚     "message": "Quotes generated successfully",                                         â”‚
â”‚     "error": false                                                                      â”‚
â”‚   }                                                                                     â”‚
â”‚ }                                                                                       â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## EXTERNAL SERVICE CALLS SUMMARY

| Call # | Service | Method | Endpoint | Purpose | Input | Output |
|--------|---------|--------|----------|---------|-------|--------|
| #1 | CommonVerticalService | getCustomerDetails() | Internal | Get customer profile | customerId, broker, tenant | CustomerDetails |
| #2 | ProductCatalogV2Service | getLiveProductListFromHub() | Internal | Get available plans | broker, productCode, "LIFE" | List<ProductWithVariants> |
| #3 | ProductCatalogV2Service | validateAndGenerateValidationMap() | Internal | Validate eligibility | productCodes, validation scope | List<ValidatedProducts> |
| #4 | ProductCatalogV2Service | getAggregatedProductInfo() | Internal | Get product + addons | ProductCatalogV2Request | Product with addons |
| #5 | AddonsService | getAddOnDataByCodeRemote() | Internal | Get addon details | addonCodes, insurerCode | List<AddOn> |
| #6 | Insurance Hub | sendPremiumRequestToIH() | External | Calculate premium | CreditLifePremiumServiceRequest | IHResponse with premium |

---

## DATABASE OPERATIONS SUMMARY

| Operation | Database | Collection | Action | Key Fields |
|-----------|----------|-----------|--------|------------|
| #1 | MongoDB | credit_life_premium_request | INSERT | referenceId, quoteId, customerId, riskInsured |
| #1B | MongoDB | premium_request_history | INSERT | premiumRequest, createdAt (audit) |
| #1C | DB Query | loan_type_masters | SELECT | bankLoanType, broker, provider |
| #1D | DB Query | integrations_hub_constants | SELECT | insurerCode, stage, broker, provider |
| #2 | MongoDB | credit_life_premium_result | INSERT (DRAFT) | referenceId, quoteId, planCode, status=DRAFT |
| #3 | MongoDB | credit_life_premium_result | UPDATE | status=SUCCESS, premium details (from IH) |

---

## KEY TRANSFORMATIONS

```
1. PremiumRequest â†’ CreditLifePremiumRequest
   â”œâ”€ Validate structure
   â”œâ”€ Encrypt sensitive fields
   â””â”€ Apply retention logic

2. CreditLifePremiumRequest + ProductWithVariants â†’ CreditLifePremiumServiceRequest
   â”œâ”€ For each eligible plan
   â””â”€ Create request with plan-specific details

3. CreditLifePremiumServiceRequest â†’ IHRequest (via IHRequestBuilder)
   â”œâ”€ Build request for Insurance Hub
   â””â”€ Set authentication credentials

4. IHResponse â†’ CreditLifePremiumResult
   â”œâ”€ Parse premium calculation response
   â”œâ”€ Extract premium, GST, commission
   â””â”€ Store in database

5. List<CreditLifePremiumResult> â†’ PremiumResponse
   â”œâ”€ Aggregate all quotes
   â”œâ”€ Include original request
   â””â”€ Return to client
```

---

## ERROR SCENARIOS

### Scenario 1: Validation Failure
```
Input Request
  â†“
Validation Failed
  â†“
Return: HTTP 400 BAD_REQUEST
Response: {
  "responseStatus": "FAILURE",
  "data": {
    "errors": [
      {
        "field": "sumInsured",
        "message": "Sum insured must be between 100000 and 5000000",
        "code": "VALIDATION_FAILED"
      }
    ]
  }
}
  â†“
Database: No save (validation failed)
```

### Scenario 2: Insurance Hub Failure
```
Phase 6: Send to IH
  â†“
IHService returns: IHResponse { success: false, errorMessage: "..." }
  â†“
updatePremiumResult():
  â”œâ”€ Set status = "FAILURE"
  â”œâ”€ Set errorMessage from IH
  â””â”€ Save to database
  â†“
Include in response with status = "FAILURE"
  â†“
Client still receives 200 OK (with failure status inside)
```

### Scenario 3: Database Error
```
Save Operation Failed
  â†“
Exception logged
  â†“
Return: HTTP 500 INTERNAL_SERVER_ERROR
Response: {
  "responseStatus": "FAILURE",
  "meta": {
    "message": "Server error occurred",
    "error": true
  }
}
```

---

## PERFORMANCE CHARACTERISTICS

- **Parallel Processing:** Customer, product list, and loan type fetched concurrently
- **Streaming:** Results returned as Flux for memory efficiency
- **Async DB Saves:** Non-blocking database operations using Schedulers.elastic()
- **Timeout Handling:** Circuit breaker patterns for external services
- **Caching:** Catalog and IH constants cached to reduce lookup time

---

## Data Retention & Audit Trail

All requests and results are stored in MongoDB for:
- **Audit Trail:** Complete history of all quote generation requests
- **Debugging:** Easy retrieval of requests that failed
- **Compliance:** Records maintained for regulatory requirements
- **Analytics:** Usage patterns and premium trends analysis

